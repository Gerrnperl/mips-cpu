# MIPS-CPU

单周期 MIPS32 指令集 CPU 设计。

## 设计

### 指令集

共支持 30 条指令，包括 R-Type, I-Type, J-Type 三种类型。

指令集设计基于 MIPS32 指令集，并作了一些修改和简化。主要在 op 和 func 的分配上进行了调整。

此外，op = 0b111111 指令作为挂起指令，PC 将不会更新.

#### R-Type

| id  | 描述                               | 指令 | 31:26  | 25: 21 | 20:16  | 15:11  | 10:6  | 5:0    |
| --- | ---------------------------------- | ---- | ------ | ------ | ------ | ------ | ----- | ------ |
|     |                                    |      | op     | rs     | rt     | rd     | shamt | func   |
| 1   | 加                                 | add  | 000000 | rs     | rt     | rd     | 00000 | 100000 |
| 2   | 减                                 | sub  | 000000 | rs     | rt     | rd     | 00000 | 100001 |
| 3   | 与                                 | and  | 000000 | rs     | rt     | rd     | 00000 | 100010 |
| 4   | 或                                 | or   | 000000 | rs     | rt     | rd     | 00000 | 100011 |
| 5   | 异或                               | xor  | 000000 | rs     | rt     | rd     | 00000 | 100100 |
| 6   | rt左移shamt                        | sll  | 000000 | 00000  | rt     | rd     | shamt | 000101 |
| 7   | rt逻辑右移shamt                    | srl  | 000000 | 00000  | rt     | rd     | shamt | 000110 |
| 8   | rt算数右移shamt                    | sra  | 000000 | 00000  | rt     | rd     | shamt | 000111 |
| 9   | 乘                                 | mul  | 000000 | rs     | rt     | rd     | 00000 | 101000 |
| 10  | 高32位(a\*b)<br/>a,b有符号扩展     | mulh | 000000 | rs     | rt     | rd     | 00000 | 101001 |
| 11  | 除                                 | div  | 000000 | rs     | rt     | rd     | 00000 | 101010 |
| 12  | 余                                 | rem  | 000000 | rs     | rt     | rd     | 00000 | 101011 |
| 13  | rd = rs &lt; rt ? 1 : 0            | slt  | 000000 | rs     | rt     | rd     | 00000 | 101100 |
| 14  | rd = rs &lt; rt ? 1 : 0<br/>无符号 | sltu | 000000 | rs     | rt     | rd     | 00000 | 101101 |
| 15  | 或非                               | nor  | 000000 | rs     | rt     | rd     | 00000 | 101110 |
| 16  | PC = rs                            | jr   | 000000 | rs     | 000000 | 000000 | 00000 | 001111 |

#### I-Type

| id  | 描述                               | 指令  | 31:26  | 25: 21 | 20:16 | 15:0 |
| --- | ---------------------------------- | ----- | ------ | ------ | ----- | ---- |
|     |                                    |       | op     | rs     | rt    | imm  |
| 17  | 加                                 | addi  | 001000 | rs     | rt    | imm  |
| 18  | 减                                 | subi  | 001001 | rs     | rt    | imm  |
| 19  | 与                                 | andi  | 001100 | rs     | rt    | imm  |
| 20  | 或                                 | ori   | 001101 | rs     | rt    | imm  |
| 21  | 异或                               | xori  | 001110 | rs     | rt    | imm  |
| 22  | rt = s_imm << 16                   | lui   | 001111 | 00000  | rt    | imm  |
| 23  | load rt = [rs + s_imm]             | lw    | 100011 | rs     | rt    | imm  |
| 24  | store [rs + s_imm] = rt            | sw    | 101011 | rs     | rt    | imm  |
| 25  | rs = rt 时<br/>PC += 4+s_imm << 2  | beq   | 000100 | rs     | rt    | imm  |
| 26  | rs != rt 时<br/>PC += 4+s_imm << 2 | bne   | 000101 | rs     | rt    | imm  |
| 27  | rt = rs < s_imm ? 1 : 0            | slti  | 001010 | rs     | rt    | imm  |
| 28  | rt = rs < z_imm ? 1 : 0            | sltiu | 001011 | rs     | rt    | imm  |

#### J-Type

| id  | 描述                                   | 指令 | 31:26  | 25:0    |
| --- | -------------------------------------- | ---- | ------ | ------- |
|     |                                        |      | op     | address |
| 29  | PC = (PC+4)[31..28), addr, 0,0         | jr   | 000010 | address |
| 30  | R31=PC; PC = (PC+4)[31..28), addr, 0,0 | jal  | 000011 | address |

### 控制信号

| 信号         | 功能定义           | 赋值0时动作      | 赋值1时动作                         |
| ------------ | ------------------ | ---------------- | ----------------------------------- |
| jump         | J指令目标地址选择  | 由Branch决定输出 | 选择J目标地址                       |
| branch       | B指令目标地址选择  | 选择PC+4地址     | 选择转移地址 PC = (PC+4) + Imm \* 4 |
| aluSrcA      | ALU端口A输入选择   | 选择寄存器rs数据 | 选择 shamt                          |
| aluSrcB      | ALU端口B输入选择   | 选择寄存器rt数据 | 选择32位立即数(符号扩展后)          |
| memRead      | 存储器读控制       | 禁止存储器读     | 使能存储器读                        |
| memWrite     | 存储器写控制       | 禁止存储器写     | 使能存储器写                        |
| memtoReg     | 寄存器写入数据选择 | 选择ALU输出      | 选择存储器数据                      |
| regWrite     | 寄存器写控制       | 禁止寄存器写     | 使能寄存器写                        |
| regDst       | 寄存器写地址选择   | 选择指令rt域     | 选择指令rd域                        |
| aluCtrl | 4位ALU操作控制     |                  |                                     |

| id  | 指令  | jump | branch | aluSrcA | aluSrcB | memRead | memWrite | memToReg | regWrite | regDst | aluOp | aluCtrl |
| --- | ----- | ---- | ------ | ------- | ------- | ------- | -------- | -------- | -------- | ------ | ----- | ------- |
| 1   | add   | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 0000    |
| 2   | sub   | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 0001    |
| 3   | and   | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 0010    |
| 4   | or    | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 0011    |
| 5   | xor   | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 0100    |
| 6   | sll   | 0    | 0      | 1       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 0101    |
| 7   | srl   | 0    | 0      | 1       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 0110    |
| 8   | sra   | 0    | 0      | 1       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 0111    |
| 9   | mul   | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 1000    |
| 10  | mulh  | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 1001    |
| 11  | div   | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 1010    |
| 12  | rem   | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 1011    |
| 13  | slt   | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 1100    |
| 14  | sltu  | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 1101    |
| 15  | nor   | 0    | 0      | 0       | 0       | 0       | 0        | 0        | 1        | 1      | 0010  | 1110    |
| 16  | jr    | 1    | 0      | 0       | 0       | 0       | 0        | 0        | 0        | 0      | 0010  | 1111    |
|     |       |      |        |         |         |         |          |          |          |        |       |         |
| 17  | addi  | 0    | 0      | 0       | 1       | 0       | 0        | 0        | 1        | 0      | 0000  | 0000    |
| 18  | subi  | 0    | 0      | 0       | 1       | 0       | 0        | 0        | 1        | 0      | 0001  | 0001    |
| 19  | andi  | 0    | 0      | 0       | 1       | 0       | 0        | 0        | 1        | 0      | 1000  | 0010    |
| 20  | ori   | 0    | 0      | 0       | 1       | 0       | 0        | 0        | 1        | 0      | 1001  | 0011    |
| 21  | xori  | 0    | 0      | 0       | 1       | 0       | 0        | 0        | 1        | 0      | 1010  | 0100    |
| 22  | lui   | 0    | 0      | 1       | 1       | 0       | 0        | 0        | 1        | 0      | 1011  | 0101    |
| 23  | lw    | 0    | 0      | 0       | 1       | 1       | 0        | 1        | 1        | 0      | 0000  | 0000    |
| 24  | sw    | 0    | 0      | 0       | 1       | 0       | 1        | X        | 0        | X      | 0000  | 0000    |
| 25  | beq   | 0    | 1      | 0       | 0       | 0       | 0        | X        | 0        | X      | 0001  | 0001    |
| 26  | bne   | 0    | 1      | 0       | 0       | 0       | 0        | X        | 0        | X      | 0001  | 0001    |
| 27  | slti  | 0    | 0      | 0       | 1       | 0       | 0        | 0        | 1        | 0      | 1100  | 1100    |
| 28  | sltiu | 0    | 0      | 0       | 1       | 0       | 0        | 0        | 1        | 0      | 1101  | 1101    |
|     |       |      |        |         |         |         |          |          |          |        |       |         |
| 29  | jr    | 1    | X      |         | X       | X       | X        | X        | X        | X      | 1111  | 1111    |
| 30  | jal   | 1    | X      |         | X       | X       | X        | X        | X        | X      | 1111  | 1111    |

### ALU

算术逻辑单元

根据4位操作码func，对两个32位操作数a、b进行运算，输出32位结果result

输出负标志negative、零标志zero、进位标志carry、溢出标志overflow

| 操作码 (func)  | 操作             | 结果 (result)                   | 进位标志 (carry)  | 溢出标志 (overflow) |
|---------------|-----------------|--------------------------------|------------------|---------------------|
| 0000          | signed add      | a + b                          | 进位为1           | 溢出为1              |
| 0001          | signed sub      | a - b                          | 借位为1           | 溢出为1              |
| 0010          | and             | a & b                          | 0                | 0                   |
| 0011          | or              | a \| b                         | 0                | 0                   |
| 0100          | xor             | a ^ b                          | 0                | 0                   |
| 0101          | shift left      | a << b[4:0]                    | 移出值的末位       | 0                   |
| 0110          | shift right     | a >> b[4:0]                    | a[0]             | 0                   |
| 0111          | arith shift right | a_signed >>> b[4:0]          | a[0]             | 0                   |
| 1000          | mul             | a * b                          | 0                | 0                   |
| 1009          | mulh            | 高32位(a * b), a、b进行有符号扩展  | 0                | 0                   |
| 1010          | div             | a / b                          | 0                | 0                   |
| 1011          | rem             | a % b                          | 0                | 0                   |
| 1100          | slt             | (a_signed < b_signed) ? 1 : 0  | 0                | 0                   |
| 1101          | sltu            | (a < b) ? 1 : 0                | 0                | 0                   |
| 1110          | nor             | ~(a \| b)                      | 0                | 0                   |
| default       | default         | 0                              | 0                | 0                   |
* 加减法无符号溢出时，进位标志为1
* 加减法有符号溢出时，溢出标志为1
* 负标志判断不考虑操作数的形式，忽略溢出，仅在result[31]为1时为1
* 零标志在result为0时为1

## 汇编器

在 [asm](./asm) 目录下提供了一个简单的汇编器，使用 TypeScript 编写。支持的指令集与 CPU 设计中的指令集一致。

### 依赖

- Node.js

#### 开发及编译依赖

- pnpm

```bash
pnpm install

# 编译
pnpm run build
```

### 使用

```bash
node /path/to/asm/dist/index.js <input.asm> [<output.bin>] [<output.coe>] [<output.txt>]

# 或者
pnpm start <input.asm> [<output.bin>] [<output.coe>] [<output.txt>]
```

- `input.asm`：输入的汇编文件
- `output.bin`：(可选) 输出二进制文件, 需要以 `.bin` 结尾
- `output.coe`：(可选) 输出 COE 文件, 需要以 `.coe` 结尾
- `output.txt`：(可选) 输出用户友好的文本文件, 包含汇编指令和对应的机器码, 需要以 `.txt` 结尾